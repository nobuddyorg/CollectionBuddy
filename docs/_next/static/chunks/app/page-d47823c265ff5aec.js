(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{5983:(e,t,a)=>{"use strict";a.d(t,{N:()=>r});let r=(0,a(2354).UU)("http://localhost:54321","dummy_anon_key")},6561:(e,t,a)=>{Promise.resolve().then(a.bind(a,7348))},7348:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>u});var r=a(5155),l=a(2115),s=a(5983);function i(e){let{selectedCat:t,onSelect:a}=e,[i,n]=(0,l.useState)([]),[d,c]=(0,l.useState)("");(0,l.useEffect)(()=>{o()},[]);let o=async()=>{let{data:e,error:t}=await s.N.from("categories").select("id,name").order("name");if(t)throw t;n(e||[])},u=async()=>{if(!d.trim())return;let{data:e,error:t}=await s.N.from("categories").insert({name:d.trim()}).select("id").single();if(t)throw t;c(""),await o(),e&&a(e.id)},m=async e=>{confirm("Delete this category?")&&(await s.N.from("categories").delete().eq("id",e),a(null),await o())};return(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,r.jsxs)("select",{value:t||"",onChange:e=>a(e.target.value||null),className:"border rounded px-2 py-1 flex-1",children:[(0,r.jsx)("option",{value:"",children:"-- Select category --"}),i.map(e=>(0,r.jsx)("option",{value:e.id,children:e.name},e.id))]}),t&&(0,r.jsx)("button",{onClick:()=>m(t),className:"px-3 py-1 rounded border border-red-500 text-red-500",children:"Delete"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("input",{value:d,onChange:e=>c(e.target.value),placeholder:"New category",className:"border rounded px-2 py-1 flex-1"}),(0,r.jsx)("button",{onClick:u,className:"px-3 py-1 rounded bg-black text-white",children:"Add"})]})]})}function n(e){let{categoryId:t,onCreated:a}=e,[i,n]=(0,l.useState)(""),[d,c]=(0,l.useState)(""),[o,u]=(0,l.useState)(""),[m,p]=(0,l.useState)(""),h=async()=>{if(!i.trim())return;let e=""!==o.trim()&&""!==m.trim()?"SRID=4326;POINT(".concat(Number(m)," ").concat(Number(o),")"):null,{data:r,error:l}=await s.N.from("items").insert({title:i.trim(),description:d.trim()||null,location:e}).select("id").single();if(l||!r)throw null!=l?l:Error("Insert returned no row");let h=r.id;await s.N.from("item_categories").insert({item_id:h,category_id:t}),n(""),c(""),u(""),p(""),a()};return(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("input",{value:i,onChange:e=>n(e.target.value),placeholder:"Title",className:"border rounded px-2 py-1 flex-1"}),(0,r.jsx)("input",{value:d,onChange:e=>c(e.target.value),placeholder:"Description",className:"border rounded px-2 py-1 flex-1"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("input",{value:o,onChange:e=>u(e.target.value),placeholder:"Lat (optional)",className:"border rounded px-2 py-1 flex-1"}),(0,r.jsx)("input",{value:m,onChange:e=>p(e.target.value),placeholder:"Lng (optional)",className:"border rounded px-2 py-1 flex-1"})]}),(0,r.jsx)("button",{onClick:h,className:"px-3 py-1 rounded bg-black text-white",children:"Add"})]})}var d=a(6766);function c(e){let{categoryId:t}=e,[a,i]=(0,l.useState)([]),[n,c]=(0,l.useState)(1),[o,u]=(0,l.useState)(0),[m,p]=(0,l.useState)(null),[h,x]=(0,l.useState)(null),[g,f]=(0,l.useState)({});(0,l.useEffect)(()=>{s.N.auth.getUser().then(e=>{var t,a;let{data:r}=e;return p(null!=(a=null==(t=r.user)?void 0:t.id)?a:null)})},[]);let N=(0,l.useCallback)(async()=>{let e=(n-1)*5,{data:a,error:r,count:l}=await s.N.from("items").select("id,title,description,item_categories!inner(category_id)",{count:"exact"}).eq("item_categories.category_id",t).order("created_at",{ascending:!1}).range(e,e+5-1).returns();if(r)throw r;i((null!=a?a:[]).map(e=>({id:e.id,title:e.title,description:e.description}))),u(l||0)},[t,n]);(0,l.useEffect)(()=>{N()},[N]);let v=(0,l.useCallback)(async e=>{var t;let{data:a}=await s.N.auth.getUser(),r=null==(t=a.user)?void 0:t.id;if(!r)return;let l="".concat(r,"/").concat(e),{data:i,error:n}=await s.N.storage.from("item-images").list(l,{limit:12,sortBy:{column:"created_at",order:"desc"}});if(n)return;if(!(null==i?void 0:i.length))return void f(t=>({...t,[e]:[]}));let d=i.map(e=>"".concat(l,"/").concat(e.name)),c=await Promise.all(d.map(async e=>{let{data:t,error:a}=await s.N.storage.from("item-images").createSignedUrl(e,3600);return a?"":(null==t?void 0:t.signedUrl)||""}));f(t=>({...t,[e]:c.filter(Boolean)}))},[]),b=(0,l.useCallback)(async e=>{await Promise.all(e.map(e=>v(e)))},[v]);(0,l.useEffect)(()=>{a.length&&m&&b(a.map(e=>e.id))},[a,m,b]);let y=async e=>{confirm("Delete this item?")&&(await s.N.from("items").delete().eq("id",e).throwOnError(),await N())},j=async(e,t)=>{try{var a;x(e);let{data:r}=await s.N.auth.getUser(),l=null==(a=r.user)?void 0:a.id;if(!l)throw Error("No user session");let i="".concat(l,"/").concat(e,"/").concat(crypto.randomUUID(),"-").concat(t.name),{error:n}=await s.N.storage.from("item-images").upload(i,t);if(n)throw n;await v(e)}catch(e){alert(e instanceof Error?e.message:String(e))}finally{x(null)}},w=Math.ceil(o/5);return(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)("ul",{className:"space-y-3",children:a.map(e=>{var t;return(0,r.jsxs)("li",{className:"border rounded p-3 space-y-3",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("div",{className:"font-medium",children:e.title}),(0,r.jsx)("button",{onClick:()=>y(e.id),className:"px-2 py-1 rounded border border-red-500 text-red-500",children:"Delete"})]}),(0,r.jsxs)("div",{className:"flex gap-3 items-center",children:[(0,r.jsx)("input",{type:"file",accept:"image/*",disabled:!m||h===e.id,onChange:t=>{var a;let r=null==(a=t.target.files)?void 0:a[0];r&&(f(t=>({...t,[e.id]:[URL.createObjectURL(r),...t[e.id]||[]]})),j(e.id,r))}}),h===e.id&&(0,r.jsx)("span",{className:"text-sm",children:"Uploadingâ€¦"})]}),(null==(t=g[e.id])?void 0:t.length)?(0,r.jsx)("div",{className:"grid grid-cols-4 gap-2",children:g[e.id].map((e,t)=>(0,r.jsx)(d.default,{src:e,alt:"",width:160,height:160,unoptimized:!0,className:"h-20 w-full object-cover rounded"},t))}):(0,r.jsx)("div",{className:"text-sm opacity-60",children:"No images"})]},e.id)})}),w>1&&(0,r.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,r.jsx)("button",{disabled:1===n,onClick:()=>c(e=>e-1),className:"px-2 py-1 rounded border disabled:opacity-50",children:"Prev"}),(0,r.jsxs)("span",{className:"text-sm",children:["Page ",n," / ",w]}),(0,r.jsx)("button",{disabled:n===w,onClick:()=>c(e=>e+1),className:"px-2 py-1 rounded border disabled:opacity-50",children:"Next"})]})]})}var o=a(5695);function u(){let[e,t]=(0,l.useState)(null),[a,d]=(0,l.useState)(null),[u,m]=(0,l.useState)(0),[p,h]=(0,l.useState)(!0),x=(0,o.useRouter)();return((0,l.useEffect)(()=>{let{data:e}=s.N.auth.onAuthStateChange((e,a)=>{var r;t(null!=(r=null==a?void 0:a.user)?r:null),h(!1),a||x.push("/login")});return s.N.auth.getUser().then(e=>{var a;e.data.user||x.push("/login"),t(null!=(a=e.data.user)?a:null),h(!1)}),()=>e.subscription.unsubscribe()},[x]),p)?(0,r.jsx)("div",{className:"loading-overlay",children:(0,r.jsx)("div",{className:"spinner"})}):e?(0,r.jsxs)("main",{className:"min-h-[100dvh] p-8 flex flex-col gap-8 max-w-2xl mx-auto bg-white text-neutral-900 dark:bg-neutral-950 dark:text-neutral-100 pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)] overscroll-y-contain",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{className:"text-sm opacity-70",children:e.email}),(0,r.jsx)("button",{onClick:()=>s.N.auth.signOut(),className:"px-3 py-1 rounded border border-neutral-300 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-900",children:"Sign out"})]}),(0,r.jsx)(i,{selectedCat:a,onSelect:d}),a&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n,{categoryId:a,onCreated:()=>m(e=>e+1)}),(0,r.jsx)(c,{categoryId:a},u)]})]}):null}}},e=>{e.O(0,[192,766,441,964,358],()=>e(e.s=6561)),_N_E=e.O()}]);