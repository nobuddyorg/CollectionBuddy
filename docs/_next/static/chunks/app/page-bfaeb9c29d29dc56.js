(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{5983:(e,t,a)=>{"use strict";a.d(t,{N:()=>r});let r=(0,a(2354).UU)("https://mopbqdyfjvdfpffhetyf.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vcGJxZHlmanZkZnBmZmhldHlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MzQ2NDUsImV4cCI6MjA3MDQxMDY0NX0.qtzuwQn1QB3tOtN2u7mnEigMa2VBIyAxu_eU6cEXc68")},6561:(e,t,a)=>{Promise.resolve().then(a.bind(a,7348))},7348:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>u});var r=a(5155),s=a(2115),l=a(5983);function i(e){let{selectedCat:t,onSelect:a}=e,[i,n]=(0,s.useState)([]),[d,c]=(0,s.useState)("");(0,s.useEffect)(()=>{o()},[]);let o=async()=>{let{data:e,error:t}=await l.N.from("categories").select("id,name").order("name");if(t)throw t;n(e||[])},u=async()=>{if(!d.trim())return;let{data:e,error:t}=await l.N.from("categories").insert({name:d.trim()}).select("id").single();if(t)throw t;c(""),await o(),e&&a(e.id)},m=async e=>{confirm("Delete this category?")&&(await l.N.from("categories").delete().eq("id",e),a(null),await o())};return(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,r.jsxs)("select",{value:t||"",onChange:e=>a(e.target.value||null),className:"border rounded px-2 py-1 flex-1",children:[(0,r.jsx)("option",{value:"",children:"-- Select category --"}),i.map(e=>(0,r.jsx)("option",{value:e.id,children:e.name},e.id))]}),t&&(0,r.jsx)("button",{onClick:()=>m(t),className:"px-3 py-1 rounded border border-red-500 text-red-500",children:"Delete"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("input",{value:d,onChange:e=>c(e.target.value),placeholder:"New category",className:"border rounded px-2 py-1 flex-1"}),(0,r.jsx)("button",{onClick:u,className:"px-3 py-1 rounded bg-black text-white",children:"Add"})]})]})}function n(e){let{categoryId:t,onCreated:a}=e,[i,n]=(0,s.useState)(""),[d,c]=(0,s.useState)(""),[o,u]=(0,s.useState)(""),[m,p]=(0,s.useState)(""),x=async()=>{if(!i.trim())return;let e=""!==o.trim()&&""!==m.trim()?"SRID=4326;POINT(".concat(Number(m)," ").concat(Number(o),")"):null,{data:r,error:s}=await l.N.from("items").insert({title:i.trim(),description:d.trim()||null,location:e}).select("id").single();if(s||!r)throw null!=s?s:Error("Insert returned no row");let x=r.id;await l.N.from("item_categories").insert({item_id:x,category_id:t}),n(""),c(""),u(""),p(""),a()};return(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("input",{value:i,onChange:e=>n(e.target.value),placeholder:"Title",className:"border rounded px-2 py-1 flex-1"}),(0,r.jsx)("input",{value:d,onChange:e=>c(e.target.value),placeholder:"Description",className:"border rounded px-2 py-1 flex-1"})]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("input",{value:o,onChange:e=>u(e.target.value),placeholder:"Lat (optional)",className:"border rounded px-2 py-1 flex-1"}),(0,r.jsx)("input",{value:m,onChange:e=>p(e.target.value),placeholder:"Lng (optional)",className:"border rounded px-2 py-1 flex-1"})]}),(0,r.jsx)("button",{onClick:x,className:"px-3 py-1 rounded bg-black text-white",children:"Add"})]})}var d=a(6766);function c(e){let{categoryId:t}=e,[a,i]=(0,s.useState)([]),[n,c]=(0,s.useState)(1),[o,u]=(0,s.useState)(0),[m,p]=(0,s.useState)(null),[x,h]=(0,s.useState)(null),[g,f]=(0,s.useState)({});(0,s.useEffect)(()=>{l.N.auth.getUser().then(e=>{var t,a;let{data:r}=e;return p(null!=(a=null==(t=r.user)?void 0:t.id)?a:null)})},[]);let N=(0,s.useCallback)(async()=>{let e=(n-1)*5,{data:a,error:r,count:s}=await l.N.from("items").select("id,title,description,item_categories!inner(category_id)",{count:"exact"}).eq("item_categories.category_id",t).order("created_at",{ascending:!1}).range(e,e+5-1).returns();if(r)throw r;i((null!=a?a:[]).map(e=>({id:e.id,title:e.title,description:e.description}))),u(s||0)},[t,n]);(0,s.useEffect)(()=>{N()},[N]);let b=(0,s.useCallback)(async e=>{var t;let{data:a}=await l.N.auth.getUser(),r=null==(t=a.user)?void 0:t.id;if(!r)return;let s="".concat(r,"/").concat(e),{data:i,error:n}=await l.N.storage.from("item-images").list(s,{limit:12,sortBy:{column:"created_at",order:"desc"}});if(n)return;if(!(null==i?void 0:i.length))return void f(t=>({...t,[e]:[]}));let d=i.map(e=>"".concat(s,"/").concat(e.name)),c=await Promise.all(d.map(async e=>{let{data:t,error:a}=await l.N.storage.from("item-images").createSignedUrl(e,3600);return a?"":(null==t?void 0:t.signedUrl)||""}));f(t=>({...t,[e]:c.filter(Boolean)}))},[]),v=(0,s.useCallback)(async e=>{await Promise.all(e.map(e=>b(e)))},[b]);(0,s.useEffect)(()=>{a.length&&m&&v(a.map(e=>e.id))},[a,m,v]);let y=async e=>{confirm("Delete this item?")&&(await l.N.from("items").delete().eq("id",e).throwOnError(),await N())},j=async(e,t)=>{try{var a;h(e);let{data:r}=await l.N.auth.getUser(),s=null==(a=r.user)?void 0:a.id;if(!s)throw Error("No user session");let i="".concat(s,"/").concat(e,"/").concat(crypto.randomUUID(),"-").concat(t.name),{error:n}=await l.N.storage.from("item-images").upload(i,t);if(n)throw n;await b(e)}catch(e){alert(e instanceof Error?e.message:String(e))}finally{h(null)}},w=Math.ceil(o/5);return(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)("ul",{className:"space-y-3",children:a.map(e=>{var t;return(0,r.jsxs)("li",{className:"border rounded p-3 space-y-3",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("div",{className:"font-medium",children:e.title}),(0,r.jsx)("button",{onClick:()=>y(e.id),className:"px-2 py-1 rounded border border-red-500 text-red-500",children:"Delete"})]}),(0,r.jsxs)("div",{className:"flex gap-3 items-center",children:[(0,r.jsx)("input",{type:"file",accept:"image/*",disabled:!m||x===e.id,onChange:t=>{var a;let r=null==(a=t.target.files)?void 0:a[0];r&&(f(t=>({...t,[e.id]:[URL.createObjectURL(r),...t[e.id]||[]]})),j(e.id,r))}}),x===e.id&&(0,r.jsx)("span",{className:"text-sm",children:"Uploadingâ€¦"})]}),(null==(t=g[e.id])?void 0:t.length)?(0,r.jsx)("div",{className:"grid grid-cols-4 gap-2",children:g[e.id].map((e,t)=>(0,r.jsx)(d.default,{src:e,alt:"",width:160,height:160,unoptimized:!0,className:"h-20 w-full object-cover rounded"},t))}):(0,r.jsx)("div",{className:"text-sm opacity-60",children:"No images"})]},e.id)})}),w>1&&(0,r.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,r.jsx)("button",{disabled:1===n,onClick:()=>c(e=>e-1),className:"px-2 py-1 rounded border disabled:opacity-50",children:"Prev"}),(0,r.jsxs)("span",{className:"text-sm",children:["Page ",n," / ",w]}),(0,r.jsx)("button",{disabled:n===w,onClick:()=>c(e=>e+1),className:"px-2 py-1 rounded border disabled:opacity-50",children:"Next"})]})]})}var o=a(5695);function u(){let[e,t]=(0,s.useState)(null),[a,d]=(0,s.useState)(null),[u,m]=(0,s.useState)(0),[p,x]=(0,s.useState)(!0),h=(0,o.useRouter)();return((0,s.useEffect)(()=>{let{data:e}=l.N.auth.onAuthStateChange((e,a)=>{var r;t(null!=(r=null==a?void 0:a.user)?r:null),x(!1),a||h.push("/login")});return l.N.auth.getUser().then(e=>{var a;e.data.user||h.push("/login"),t(null!=(a=e.data.user)?a:null),x(!1)}),()=>e.subscription.unsubscribe()},[h]),p)?(0,r.jsxs)("div",{className:"fixed inset-0 z-50 flex flex-col items-center justify-center gap-3 bg-black/60 backdrop-blur-sm",children:[(0,r.jsx)("div",{className:"animate-spin h-8 w-8 rounded-full border-2 border-white/80 border-t-transparent"}),(0,r.jsx)("span",{className:"text-white text-lg font-medium",children:"Wird geladen..."})]}):e?(0,r.jsxs)("main",{className:"min-h-[100dvh] p-8 flex flex-col gap-8 max-w-2xl mx-auto bg-white text-neutral-900 dark:bg-neutral-950 dark:text-neutral-100 pt-[env(safe-area-inset-top)] pb-[env(safe-area-inset-bottom)] overscroll-y-contain",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("span",{className:"text-sm opacity-70",children:e.email}),(0,r.jsx)("button",{onClick:()=>l.N.auth.signOut(),className:"px-3 py-1 rounded border border-neutral-300 dark:border-neutral-700 hover:bg-neutral-50 dark:hover:bg-neutral-900",children:"Sign out"})]}),(0,r.jsx)(i,{selectedCat:a,onSelect:d}),a&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n,{categoryId:a,onCreated:()=>m(e=>e+1)}),(0,r.jsx)(c,{categoryId:a},u)]})]}):null}}},e=>{e.O(0,[192,766,441,964,358],()=>e(e.s=6561)),_N_E=e.O()}]);